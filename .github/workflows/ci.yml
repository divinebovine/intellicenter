---
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ============================================
  # Stage 1: Code Quality
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      - run: pip install ruff bandit mypy

      - name: Ruff lint
        run: ruff check custom_components/

      - name: Ruff format
        run: ruff format --check custom_components/

      - name: Bandit security
        run: bandit -r custom_components/intellicenter/ -ll

      - name: Type check (mypy)
        run: mypy custom_components/intellicenter/ --ignore-missing-imports

  # ============================================
  # Stage 2a: Tests (parallel with Quality Scale)
  # ============================================
  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    outputs:
      test_count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio pytest-cov \
            pytest-homeassistant-custom-component \
            "pyintellicenter>=0.1.1"
      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=custom_components/intellicenter
      - name: Count tests
        id: count
        run: |
          count=$(pytest tests/ --collect-only -q 2>/dev/null | tail -1 | grep -oE '^[0-9]+')
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Test count: $count"

  # ============================================
  # Stage 2b: Quality Scale (parallel with Tests)
  # ============================================
  bronze:
    name: "Bronze"
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@v4
      - name: Bronze checks
        run: |
          echo "## Bronze Tier" >> $GITHUB_STEP_SUMMARY
          passed=true

          # Config flow
          if test -f custom_components/intellicenter/config_flow.py; then
            echo "âœ… Config flow exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Config flow missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Strings
          if test -f custom_components/intellicenter/strings.json; then
            echo "âœ… Strings file exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Strings file missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # README
          if test -f README.md; then
            echo "âœ… README exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ README missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Tests directory
          if test -d tests/; then
            echo "âœ… Tests directory exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests directory missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          if [ "$passed" = "false" ]; then exit 1; fi

  silver:
    name: "Silver"
    runs-on: ubuntu-latest
    needs: [bronze]
    steps:
      - uses: actions/checkout@v4
      - name: Silver checks
        run: |
          echo "## Silver Tier" >> $GITHUB_STEP_SUMMARY
          passed=true

          # Troubleshooting docs
          if grep -q "## Troubleshooting" README.md; then
            echo "âœ… Troubleshooting documentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing troubleshooting docs" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Debug logging docs
          if grep -qi "debug" README.md; then
            echo "âœ… Debug logging documented" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing debug logging docs" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Error recovery
          if grep -rq "reconnect\|backoff\|retry" custom_components/intellicenter/; then
            echo "âœ… Error recovery implemented" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing error recovery" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          if [ "$passed" = "false" ]; then exit 1; fi

  gold:
    name: "Gold"
    runs-on: ubuntu-latest
    needs: [silver]
    steps:
      - uses: actions/checkout@v4
      - name: Gold checks
        run: |
          echo "## Gold Tier" >> $GITHUB_STEP_SUMMARY
          passed=true

          # Zeroconf discovery
          if grep -q "zeroconf" custom_components/intellicenter/manifest.json; then
            echo "âœ… Zeroconf discovery" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing Zeroconf" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Translations (2+ languages)
          trans_count=$(ls -1 custom_components/intellicenter/translations/*.json 2>/dev/null | wc -l)
          if [ "$trans_count" -ge 2 ]; then
            echo "âœ… Translations ($trans_count languages)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need 2+ translations (found $trans_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Options flow
          if grep -q "OptionsFlow\|async_get_options_flow" custom_components/intellicenter/config_flow.py; then
            echo "âœ… Options flow (reconfiguration)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing options flow" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Diagnostics
          if grep -q "async_get_config_entry_diagnostics" custom_components/intellicenter/diagnostics.py 2>/dev/null; then
            echo "âœ… Diagnostics support" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing diagnostics" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          if [ "$passed" = "false" ]; then exit 1; fi

  platinum:
    name: "Platinum"
    runs-on: ubuntu-latest
    needs: [gold, tests]
    steps:
      - uses: actions/checkout@v4
      - name: Platinum checks
        run: |
          echo "## Platinum Tier" >> $GITHUB_STEP_SUMMARY
          passed=true

          # 100+ tests
          test_count=${{ needs.tests.outputs.test_count }}
          if [ "$test_count" -ge 100 ]; then
            echo "âœ… 100+ tests ($test_count tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need 100+ tests (found $test_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Type annotations (already passed in code-quality)
          echo "âœ… Type annotations (mypy passed)" >> $GITHUB_STEP_SUMMARY

          # Async implementation
          if grep -rq "async def" custom_components/intellicenter/*.py; then
            echo "âœ… Async implementation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing async implementation" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Code documentation
          doc_count=$(grep -r '"""' custom_components/intellicenter/*.py | wc -l)
          if [ "$doc_count" -ge 20 ]; then
            echo "âœ… Code documentation ($doc_count docstrings)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need more documentation (found $doc_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          if [ "$passed" = "false" ]; then exit 1; fi

  # ============================================
  # Stage 3: Summary
  # ============================================
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, tests, bronze, silver, gold, platinum]
    steps:
      - name: Generate report
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.code-quality.result }}" = "success" ]; then
            echo "âœ… Lint, Type Check, Security" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Code Quality Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.tests.result }}" = "success" ]; then
            echo "âœ… ${{ needs.tests.outputs.test_count }} tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Scale" >> $GITHUB_STEP_SUMMARY
          echo "| Tier | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          [ "${{ needs.bronze.result }}" = "success" ] && echo "| Bronze | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| Bronze | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.silver.result }}" = "success" ] && echo "| Silver | âœ… |" >> $GITHUB_STEP_SUMMARY || [ "${{ needs.silver.result }}" = "skipped" ] && echo "| Silver | â­ï¸ |" >> $GITHUB_STEP_SUMMARY || echo "| Silver | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.gold.result }}" = "success" ] && echo "| Gold | âœ… |" >> $GITHUB_STEP_SUMMARY || [ "${{ needs.gold.result }}" = "skipped" ] && echo "| Gold | â­ï¸ |" >> $GITHUB_STEP_SUMMARY || echo "| Gold | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.platinum.result }}" = "success" ] && echo "| Platinum | âœ… |" >> $GITHUB_STEP_SUMMARY || [ "${{ needs.platinum.result }}" = "skipped" ] && echo "| Platinum | â­ï¸ |" >> $GITHUB_STEP_SUMMARY || echo "| Platinum | âŒ |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine tier
          tier="âŒ None"
          [ "${{ needs.bronze.result }}" = "success" ] && tier="ðŸ¥‰ Bronze"
          [ "${{ needs.silver.result }}" = "success" ] && tier="ðŸ¥ˆ Silver"
          [ "${{ needs.gold.result }}" = "success" ] && tier="ðŸ¥‡ Gold"
          [ "${{ needs.platinum.result }}" = "success" ] && tier="ðŸ’Ž Platinum"

          echo "**Achieved: $tier**" >> $GITHUB_STEP_SUMMARY

          # Fail if not platinum
          if [ "${{ needs.platinum.result }}" != "success" ]; then
            exit 1
          fi
