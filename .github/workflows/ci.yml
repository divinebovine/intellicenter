---
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ============================================
  # Code Quality
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      - run: pip install ruff bandit
      - name: Ruff lint
        run: ruff check custom_components/
      - name: Ruff format
        run: ruff format --check custom_components/
      - name: Bandit security
        run: bandit -r custom_components/intellicenter/ -ll

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      - run: pip install mypy
      - name: mypy
        run: mypy custom_components/intellicenter/ --ignore-missing-imports

  # ============================================
  # Tests
  # ============================================
  test:
    name: Tests
    runs-on: ubuntu-latest
    outputs:
      test_count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio pytest-cov \
            pytest-homeassistant-custom-component \
            "pyintellicenter>=0.1.1"
      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=custom_components/intellicenter
      - name: Count tests
        id: count
        run: |
          count=$(pytest tests/ --collect-only -q 2>/dev/null | tail -1 | grep -oE '^[0-9]+')
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Test count: $count"

  # ============================================
  # Quality Scale - Bronze
  # ============================================
  bronze:
    name: "Bronze"
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
      - name: Bronze checks
        id: check
        run: |
          passed=true
          echo "## Bronze Tier" >> $GITHUB_STEP_SUMMARY

          # Config flow
          if test -f custom_components/intellicenter/config_flow.py; then
            echo "âœ… Config flow exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Config flow missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Strings/translations
          if test -f custom_components/intellicenter/strings.json; then
            echo "âœ… Strings file exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Strings file missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # README
          if test -f README.md; then
            echo "âœ… README exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ README missing" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Tests exist (from previous job)
          if [ "${{ needs.test.outputs.test_count }}" -gt 0 ]; then
            echo "âœ… Tests exist (${{ needs.test.outputs.test_count }} tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No tests" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          echo "passed=$passed" >> $GITHUB_OUTPUT
          if [ "$passed" = "false" ]; then exit 1; fi

  # ============================================
  # Quality Scale - Silver
  # ============================================
  silver:
    name: "Silver"
    runs-on: ubuntu-latest
    needs: [bronze]
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
      - name: Silver checks
        id: check
        run: |
          passed=true
          echo "## Silver Tier" >> $GITHUB_STEP_SUMMARY

          # Troubleshooting docs
          if grep -q "## Troubleshooting" README.md; then
            echo "âœ… Troubleshooting documentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing troubleshooting docs" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Debug logging docs
          if grep -q "debug" README.md; then
            echo "âœ… Debug logging documented" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing debug logging docs" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Error recovery (ConnectionHandler)
          if grep -rq "ConnectionHandler\|reconnect\|backoff" custom_components/intellicenter/; then
            echo "âœ… Error recovery implemented" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing error recovery" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          echo "passed=$passed" >> $GITHUB_OUTPUT
          if [ "$passed" = "false" ]; then exit 1; fi

  # ============================================
  # Quality Scale - Gold
  # ============================================
  gold:
    name: "Gold"
    runs-on: ubuntu-latest
    needs: [silver]
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
      - name: Gold checks
        id: check
        run: |
          passed=true
          echo "## Gold Tier" >> $GITHUB_STEP_SUMMARY

          # Zeroconf discovery
          if grep -q "zeroconf" custom_components/intellicenter/manifest.json; then
            echo "âœ… Zeroconf discovery" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing Zeroconf" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Translations (2+ languages)
          trans_count=$(ls -1 custom_components/intellicenter/translations/*.json 2>/dev/null | wc -l)
          if [ "$trans_count" -ge 2 ]; then
            echo "âœ… Translations ($trans_count languages)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need 2+ translations (found $trans_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Options flow
          if grep -q "OptionsFlow\|async_get_options_flow" custom_components/intellicenter/config_flow.py; then
            echo "âœ… Options flow (reconfiguration)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing options flow" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Diagnostics
          if grep -q "async_get_config_entry_diagnostics" custom_components/intellicenter/diagnostics.py 2>/dev/null; then
            echo "âœ… Diagnostics support" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing diagnostics" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # 50+ tests
          if [ "${{ needs.silver.outputs.passed }}" = "true" ]; then
            echo "âœ… Comprehensive testing" >> $GITHUB_STEP_SUMMARY
          fi

          echo "passed=$passed" >> $GITHUB_OUTPUT
          if [ "$passed" = "false" ]; then exit 1; fi

  # ============================================
  # Quality Scale - Platinum
  # ============================================
  platinum:
    name: "Platinum"
    runs-on: ubuntu-latest
    needs: [gold, test]
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
      - name: Platinum checks
        id: check
        run: |
          passed=true
          echo "## Platinum Tier" >> $GITHUB_STEP_SUMMARY

          # 100+ tests
          test_count=${{ needs.test.outputs.test_count }}
          if [ "$test_count" -ge 100 ]; then
            echo "âœ… 100+ tests ($test_count tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need 100+ tests (found $test_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Type annotations (checked by mypy in typecheck job)
          echo "âœ… Type annotations (mypy passed)" >> $GITHUB_STEP_SUMMARY

          # Async implementation
          if grep -rq "async def\|await" custom_components/intellicenter/*.py; then
            echo "âœ… Async implementation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing async implementation" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          # Code documentation
          doc_count=$(grep -r '"""' custom_components/intellicenter/*.py | wc -l)
          if [ "$doc_count" -ge 20 ]; then
            echo "âœ… Code documentation ($doc_count docstrings)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Need more documentation (found $doc_count)" >> $GITHUB_STEP_SUMMARY
            passed=false
          fi

          echo "passed=$passed" >> $GITHUB_OUTPUT
          if [ "$passed" = "false" ]; then exit 1; fi

  # ============================================
  # Summary
  # ============================================
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, test, bronze, silver, gold, platinum]
    steps:
      - name: Generate report
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "âœ… Lint" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lint" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.typecheck.result }}" = "success" ]; then
            echo "âœ… Type Check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Type Check" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "âœ… Tests (${{ needs.test.outputs.test_count }} tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Scale" >> $GITHUB_STEP_SUMMARY

          # Determine highest tier achieved
          tier="None"
          if [ "${{ needs.bronze.result }}" = "success" ]; then
            tier="ðŸ¥‰ Bronze"
          fi
          if [ "${{ needs.silver.result }}" = "success" ]; then
            tier="ðŸ¥ˆ Silver"
          fi
          if [ "${{ needs.gold.result }}" = "success" ]; then
            tier="ðŸ¥‡ Gold"
          fi
          if [ "${{ needs.platinum.result }}" = "success" ]; then
            tier="ðŸ’Ž Platinum"
          fi

          echo "| Tier | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.bronze.result }}" = "success" ]; then
            echo "| Bronze | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Bronze | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.silver.result }}" = "success" ]; then
            echo "| Silver | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.silver.result }}" = "skipped" ]; then
            echo "| Silver | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Silver | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.gold.result }}" = "success" ]; then
            echo "| Gold | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.gold.result }}" = "skipped" ]; then
            echo "| Gold | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Gold | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.platinum.result }}" = "success" ]; then
            echo "| Platinum | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.platinum.result }}" = "skipped" ]; then
            echo "| Platinum | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Platinum | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Achieved: $tier**" >> $GITHUB_STEP_SUMMARY

          # Fail if not platinum
          if [ "${{ needs.platinum.result }}" != "success" ]; then
            echo "::error::Quality Scale target (Platinum) not achieved"
            exit 1
          fi
